<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Road Fighter Pro - سلمان الجنيدي</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@900&display=swap');
        
        body {
            margin: 0; background: #222; font-family: 'Cairo', sans-serif;
            color: white; overflow: hidden; display: flex; flex-direction: column; align-items: center;
            touch-action: none;
        }

        #game-wrapper {
            position: relative; width: 100%; max-width: 450px; height: 85vh;
            border: 6px solid #111; background: #333; overflow: hidden;
        }

        canvas { width: 100%; height: 100%; image-rendering: pixelated; }

        /* شاشات الواجهة */
        .overlay {
            position: absolute; inset: 0; background: rgba(0,0,0,0.85);
            display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 100;
            text-align: center; padding: 20px;
        }

        .game-title {
            color: #ffeb3b; font-size: 2.5rem; -webkit-text-stroke: 1.5px #d32f2f;
            margin-bottom: 30px; line-height: 1.2;
        }

        .btn {
            background: #d32f2f; color: white; border: 3px solid #fff; padding: 12px;
            margin: 8px; cursor: pointer; font-size: 1.2rem; font-weight: bold;
            box-shadow: 4px 4px 0 #5d0000; width: 200px; border-radius: 4px;
        }

        /* نافذة السؤال - محسنة جداً */
        #question-box {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 85%; background: #0d47a1; border: 4px solid #fff;
            padding: 15px; z-index: 200; display: none; flex-direction: column;
            border-radius: 15px; box-shadow: 0 0 50px #000;
        }

        .ans-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 15px; }
        .ans-btn {
            background: #fff; color: #0d47a1; border: none; padding: 12px;
            font-size: 1.3rem; font-weight: bold; border-radius: 8px;
        }

        /* التحكم */
        #controls {
            display: flex; width: 100%; max-width: 450px; height: 15vh;
            background: #111; justify-content: space-around; align-items: center;
        }
        .ctrl-btn {
            width: 65px; height: 65px; background: #444; border: 3px solid #777;
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            font-size: 1.8rem; user-select: none;
        }
        #gas-btn { background: #2e7d32; width: 80px; height: 80px; border-color: #4caf50; }

        footer { font-size: 0.75rem; padding: 5px; background: #000; width: 100%; text-align: center; }
    </style>
</head>
<body>

<div id="game-wrapper">
    <canvas id="gameCanvas"></canvas>

    <div id="start-screen" class="overlay">
        <div class="game-title">ROAD FIGHTER<br>MATH</div>
        <button class="btn" onclick="game.init('easy')">مبتدئ (＋/－)</button>
        <button class="btn" onclick="game.init('medium')">متوسط (×)</button>
        <button class="btn" onclick="game.init('hard')">محترف (÷/×)</button>
    </div>

    <div id="question-box">
        <div id="q-timer" style="color: #ff5252; font-size: 1.5rem; text-align: left;">١٥</div>
        <h2 id="q-text" style="margin: 10px 0; font-size: 1.8rem;">السؤال؟</h2>
        <div id="options" class="ans-grid"></div>
    </div>

    <div id="game-over" class="overlay" style="display:none">
        <h1 id="status-msg" style="color: #ff5252;">حظاً أوفر!</h1>
        <button class="btn" onclick="location.reload()">إعادة المحاولة</button>
    </div>
</div>

<div id="controls">
    <div class="ctrl-btn" id="l-btn">◀</div>
    <div class="ctrl-btn" id="gas-btn">⛽</div>
    <div class="ctrl-btn" id="r-btn">▶</div>
</div>

<footer>
    جميع الحقوق محفوظة لـ سلمان الجنيدي
    <a href="https://wa.me/966566996166" style="color:#4caf50; margin:0 10px;">واتساب</a>
    <a href="https://snapchat.com/t/2fysJJzn" style="color:#ffeb3b;">سناب</a>
</footer>

<script>
const toAr = (n) => n.toString().replace(/\d/g, d => "٠١٢٣٤٥٦٧٨٩"[d]);

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
canvas.width = 400;
canvas.height = 600;

const game = {
    active: false,
    speed: 0,
    fuel: 100,
    distance: 0,
    maxDistance: 2000, // طول المرحلة
    stage: 1,
    roadY: 0,
    playerX: 182,
    enemies: [],
    scenery: [],
    difficulty: 'easy',
    lanes: [80, 150, 220, 290],

    init(lvl) {
        this.difficulty = lvl;
        this.active = true;
        this.distance = 0;
        document.getElementById('start-screen').style.display = 'none';
        // توليد الأشجار
        for(let i=0; i<10; i++) this.scenery.push({y: i*100, side: i%2});
        this.loop();
    },

    drawCar(x, y, type) {
        const color = type === 'player' ? '#f44336' : '#ffc107';
        // Shadow
        ctx.fillStyle = 'rgba(0,0,0,0.3)';
        ctx.fillRect(x+4, y+4, 35, 55);
        // Body
        ctx.fillStyle = color;
        ctx.fillRect(x, y, 35, 55);
        // Windshield
        ctx.fillStyle = '#90caf9';
        ctx.fillRect(x+4, y+10, 27, 12);
        // Roof
        ctx.fillStyle = color;
        ctx.globalAlpha = 0.7;
        ctx.fillRect(x+4, y+22, 27, 20);
        ctx.globalAlpha = 1.0;
        // Lights
        ctx.fillStyle = '#fff';
        ctx.fillRect(x+4, y+2, 8, 4); ctx.fillRect(x+23, y+2, 8, 4);
    },

    drawScenery() {
        this.scenery.forEach(s => {
            s.y += this.speed;
            if(s.y > canvas.height) s.y = -50;
            ctx.fillStyle = '#1b5e20'; // Tree color
            let x = s.side === 0 ? 15 : 355;
            // Draw simple pixel tree
            ctx.fillRect(x, s.y, 30, 30);
            ctx.fillStyle = '#388e3c';
            ctx.fillRect(x+5, s.y+5, 20, 20);
        });
    },

    update() {
        if (!this.active) return;

        if (input.gas) {
            this.speed = Math.min(this.speed + 0.12, 8 + this.stage);
            this.fuel -= 0.05;
            this.distance += this.speed * 0.1;
        } else {
            this.speed = Math.max(this.speed - 0.08, 0);
        }

        if (this.fuel <= 0) this.over("انتهى الوقود!");
        if (this.distance >= this.maxDistance) this.nextStage();

        this.roadY += this.speed;
        if (input.left && this.playerX > 65) this.playerX -= 5;
        if (input.right && this.playerX < 300) this.playerX += 5;

        // ظهور الأعداء
        if (this.enemies.length < 3 && Math.random() < 0.03) {
            const lane = this.lanes[Math.floor(Math.random() * this.lanes.length)];
            if (!this.enemies.some(e => e.y < 150 && e.x === lane)) {
                this.enemies.push({ x: lane, y: -100, s: 1 + Math.random() * 2 });
            }
        }

        this.enemies.forEach((en, i) => {
            en.y += (this.speed * 0.5) + en.s;
            if (this.playerX < en.x + 35 && this.playerX + 35 > en.x &&
                500 < en.y + 55 && 500 + 55 > en.y) {
                this.ask();
            }
            if (en.y > canvas.height) this.enemies.splice(i, 1);
        });
    },

    draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Background & Road
        ctx.fillStyle = '#2e7d32'; ctx.fillRect(0,0, canvas.width, canvas.height);
        ctx.fillStyle = '#444'; ctx.fillRect(60, 0, 280, canvas.height);
        
        // Road Marks
        ctx.strokeStyle = '#fff'; ctx.setLineDash([30, 40]);
        ctx.lineDashOffset = -this.roadY;
        ctx.lineWidth = 4;
        [130, 200, 270].forEach(x => {
            ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, canvas.height); ctx.stroke();
        });

        this.drawScenery();

        // Finish Line
        if (this.maxDistance - this.distance < 500) {
            let lineY = canvas.height - (this.maxDistance - this.distance) - 100;
            ctx.fillStyle = '#fff';
            for(let i=0; i<7; i++) ctx.fillRect(60 + i*40, lineY, 20, 20);
        }

        this.drawCar(this.playerX, 500, 'player');
        this.enemies.forEach(en => this.drawCar(en.x, en.y, 'enemy'));

        // HUD - Fixed position
        ctx.fillStyle = "rgba(0,0,0,0.6)";
        ctx.fillRect(0, 0, canvas.width, 50);
        ctx.fillStyle = "#ffeb3b"; ctx.font = "bold 18px Cairo";
        ctx.fillText(`وقود: ${toAr(Math.ceil(this.fuel))}%`, 20, 32);
        ctx.fillText(`سرعة: ${toAr(Math.floor(this.speed * 40))}`, 155, 32);
        ctx.fillText(`مرحلة: ${toAr(this.stage)}`, 310, 32);
    },

    nextStage() {
        this.stage++;
        this.distance = 0;
        this.fuel = 100;
        this.enemies = [];
        this.speed = 0;
        alert(`أحسنت! انتقلت للمرحلة ${toAr(this.stage)}`);
    },

    ask() {
        this.active = false;
        const box = document.getElementById('question-box');
        const qData = this.genQ();
        box.style.display = 'flex';
        document.getElementById('q-text').innerText = qData.txt;
        const optsDiv = document.getElementById('options');
        optsDiv.innerHTML = '';
        
        let timeLeft = 15;
        const timerEl = document.getElementById('q-timer');
        timerEl.innerText = toAr(timeLeft);

        const timerId = setInterval(() => {
            timeLeft--;
            timerEl.innerText = toAr(timeLeft);
            if (timeLeft <= 0) { clearInterval(timerId); this.over("انتهى الوقت!"); }
        }, 1000);

        qData.opts.forEach(o => {
            const b = document.createElement('button');
            b.className = 'ans-btn';
            b.innerText = toAr(o);
            b.onclick = () => {
                clearInterval(timerId);
                if (o === qData.ans) {
                    box.style.display = 'none';
                    this.fuel = 100; this.enemies = []; this.active = true; this.loop();
                } else { this.over("إجابة خاطئة!"); }
            };
            optsDiv.appendChild(b);
        });
    },

    genQ() {
        let a, b, ans, txt;
        if (this.difficulty === 'easy') {
            a = Math.floor(Math.random()*11); b = Math.floor(Math.random()*11);
            if (Math.random()>0.5) { txt = `${toAr(a)} ＋ ${toAr(b)}`; ans = a+b; }
            else { txt = `${toAr(Math.max(a,b))} － ${toAr(Math.min(a,b))}`; ans = Math.max(a,b)-Math.min(a,b); }
        } else if (this.difficulty === 'medium') {
            a = Math.floor(Math.random()*11); b = Math.floor(Math.random()*11);
            txt = `${toAr(a)} × ${toAr(b)}`; ans = a*b;
        } else {
            if (Math.random()>0.5) {
                a = Math.floor(Math.random()*13); b = Math.floor(Math.random()*13);
                txt = `${toAr(a)} × ${toAr(b)}`; ans = a*b;
            } else {
                ans = Math.floor(Math.random()*10); b = Math.floor(Math.random()*9)+1;
                a = ans * b; txt = `${toAr(a)} ÷ ${toAr(b)}`;
            }
        }
        let opts = [ans, ans+1, ans+5, ans-1].filter(n => n >= 0).sort(() => Math.random()-0.5);
        return { txt, ans, opts: [...new Set(opts)].slice(0,4) };
    },

    over(msg) {
        this.active = false;
        document.getElementById('question-box').style.display = 'none';
        document.getElementById('status-msg').innerText = msg + "\nحظاً أوفر في المرة القادمة";
        document.getElementById('game-over').style.display = 'flex';
    },

    loop() {
        if (!this.active) return;
        this.update();
        this.draw();
        requestAnimationFrame(() => this.loop());
    }
};

const input = { left: false, right: false, gas: false };
window.onkeydown = (e) => {
    if (e.key === 'ArrowLeft') input.left = true;
    if (e.key === 'ArrowRight') input.right = true;
    if (e.key === 'ArrowUp' || e.key === ' ') input.gas = true;
};
window.onkeyup = (e) => {
    if (e.key === 'ArrowLeft') input.left = false;
    if (e.key === 'ArrowRight') input.right = false;
    if (e.key === 'ArrowUp' || e.key === ' ') input.gas = false;
};
const setupBtn = (id, key) => {
    const el = document.getElementById(id);
    el.onpointerdown = (e) => { e.preventDefault(); input[key] = true; };
    el.onpointerup = (e) => { e.preventDefault(); input[key] = false; };
};
setupBtn('l-btn', 'left'); setupBtn('r-btn', 'right'); setupBtn('gas-btn', 'gas');
</script>
</body>
</html>
